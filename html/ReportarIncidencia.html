<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reporte de Incidencia - Cusco Reporta</title>
  
  <!-- RUTAS CORREGIDAS para Netlify -->
  <link rel="stylesheet" href="css/ReporteIncidencia.css" />
  <link rel="stylesheet" href="css/styles.css" />
  
  <style>
    /* Estilos adicionales si ReporteIncidencia.css no existe */
    .reporte-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 30px;
    }
    
    .form-section, .form-map {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    label {
      display: block;
      font-weight: 600;
      margin: 15px 0 8px;
      color: #333;
    }
    
    select, textarea, input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .file-upload {
      margin: 20px 0;
      text-align: center;
    }
    
    .file-upload label {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      background: #f8f9fa;
      border: 2px dashed #8b0000;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .file-upload img {
      width: 24px;
      height: 24px;
    }
    
    button#enviar {
      background: #8b0000;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      transition: background 0.3s;
    }
    
    button#enviar:hover {
      background: #a52a2a;
    }
    
    .form-map img {
      width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 10px;
    }
    
    /* Loading state */
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .reporte-form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- ======= BARRA SUPERIOR ======= -->
  <div class="topbar">
    <div class="topbar__logo">
      <!-- RUTA CORREGIDA -->
      <img src="assents/images/CuscoReporta.png" alt="Cusco Reporta" />
    </div>
    <div class="topbar__menu">
      <a href="index.html">Inicio</a>
      <a href="sobre_nosotros.html">Sobre nosotros</a>
      <a href="ayuda.html">Cont√°ctenos</a>
      <a href="ayuda.html">Ayuda</a>
    </div>
  </div>

  <!-- ======= CONTENEDOR PRINCIPAL ======= -->
  <div class="container">
    <!-- ======= SIDEBAR ======= -->
    <aside class="sidebar">
      <div class="sidebar__user">
        <div class="sidebar__avatar">üë§</div>
        <div class="sidebar__info">
          <h3 id="userName">Usuario</h3>
          <p id="userRole">Ciudadano</p>
        </div>
      </div>

      <ul class="sidebar__menu">
        <li><a href="perfil_usuario.html">Ver perfil</a></li>
        <li><a href="ReportarIncidencia.html" class="active">Reportar</a></li>
        <li><a href="consultas.html">Estado de reportes</a></li>
        <li><a href="MapaIncidiencias(Ciudadano).html">Mapa de incidencias</a></li>
        <li><a href="notificaciones.html">Notificaciones</a></li>
      </ul>

      <button class="logout-btn" id="logoutBtn">Cerrar sesi√≥n</button>
    </aside>

    <!-- ======= CONTENIDO PRINCIPAL ======= -->
    <main class="main-content">
      <h1>REPORTE DE INCIDENCIA</h1>
      <p style="color: #666; margin-bottom: 20px;">Reporta cualquier incidencia de tr√°nsito en Cusco</p>

      <div class="reporte-form">
        <div class="form-section">
          <form id="formReporte">
            <label for="tipo">Tipo de incidencia *</label>
            <select id="tipo" required>
              <option value="">Seleccione incidencia</option>
              <option value="Accidente">Accidente</option>
              <option value="Bache o hueco">Bache o hueco</option>
              <option value="Sem√°foro da√±ado">Sem√°foro da√±ado</option>
              <option value="Alumbrado p√∫blico">Alumbrado p√∫blico</option>
              <option value="Exceso de velocidad">Exceso de velocidad</option>
              <option value="Mal estacionamiento">Mal estacionamiento</option>
              <option value="Obstrucci√≥n de v√≠a">Obstrucci√≥n de v√≠a</option>
              <option value="Otro">Otro</option>
            </select>

            <label for="descripcion">Descripci√≥n detallada *</label>
            <textarea id="descripcion" placeholder="Describe la incidencia: ubicaci√≥n exacta, hora, gravedad, etc." required></textarea>

            <label for="ubicacion">Ubicaci√≥n aproximada *</label>
            <input type="text" id="ubicacion" placeholder="Ej: Av. El Sol frente al mercado San Pedro" required>

            <div class="file-upload">
              <label for="foto">
                <img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" alt="icono c√°mara" />
                Adjuntar fotos (opcional)
              </label>
              <input type="file" id="foto" accept="image/*" multiple />
              <p style="font-size: 12px; color: #666; margin-top: 5px;">Puedes subir hasta 3 im√°genes</p>
            </div>

            <button type="submit" id="enviar">
              üì§ Enviar Reporte
            </button>
          </form>
        </div>

        <div class="form-map">
          <p><strong>üìç Mapa de referencia:</strong></p>
          <img src="https://cdn.pixabay.com/photo/2017/01/31/13/14/map-2024428_1280.png" alt="Mapa ubicaci√≥n" />
          <p style="font-size: 14px; color: #666; margin-top: 10px;">
            <i class="fa-solid fa-info-circle"></i> En una versi√≥n futura, esto ser√° un mapa interactivo donde podr√°s seleccionar la ubicaci√≥n exacta.
          </p>
        </div>
      </div>
      
      <!-- Informaci√≥n adicional -->
      <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h3><i class="fa-solid fa-circle-info"></i> Informaci√≥n importante</h3>
        <ul style="color: #555;">
          <li>Tu reporte ser√° revisado por las autoridades correspondientes</li>
          <li>Procura ser lo m√°s espec√≠fico posible en la descripci√≥n</li>
          <li>Las fotos ayudan a una mejor identificaci√≥n del problema</li>
          <li>Recibir√°s un n√∫mero de seguimiento para consultar el estado</li>
        </ul>
      </div>
    </main>
  </div>

  <!-- Cargar FontAwesome para √≠conos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <!-- Cargar Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <script>
    // ==================== CONFIGURACI√ìN SUPABASE ====================
    const SUPABASE_URL = 'https://grchvnewfkakaqfkgbzy.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bQZ1guTH9D2ByDwgMYGLfQ_g7bIsktc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    // ================================================================

    document.addEventListener('DOMContentLoaded', function() {
      // 1. CARGAR DATOS DEL USUARIO
      const userData = sessionStorage.getItem('user');
      
      if (!userData) {
        alert('‚ùå Debes iniciar sesi√≥n para reportar incidencias.');
        window.location.href = 'iniciar-sesion.html';
        return;
      }
      
      const user = JSON.parse(userData);
      document.getElementById('userName').textContent = user.nombre || 'Usuario';
      
      // 2. CONFIGURAR LOGOUT
      document.getElementById('logoutBtn').addEventListener('click', async function() {
        if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
          await supabase.auth.signOut();
          sessionStorage.removeItem('user');
          alert('‚úÖ Sesi√≥n cerrada');
          window.location.href = 'index.html';
        }
      });
      
      // 3. MANEJAR EL FORMULARIO
      const form = document.getElementById('formReporte');
      const btnEnviar = document.getElementById('enviar');
      
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validaci√≥n b√°sica
        const tipo = document.getElementById('tipo').value;
        const descripcion = document.getElementById('descripcion').value;
        const ubicacion = document.getElementById('ubicacion').value;
        
        if (!tipo || !descripcion || !ubicacion) {
          alert('Por favor completa todos los campos obligatorios (*)');
          return;
        }
        
        // Cambiar estado del bot√≥n
        const textoOriginal = btnEnviar.innerHTML;
        btnEnviar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Enviando...';
        btnEnviar.disabled = true;
        btnEnviar.classList.add('btn-loading');
        
        try {
          // Preparar datos para Supabase
          const reporteData = {
            titulo: tipo,
            descripcion: descripcion,
            ubicacion: ubicacion,
            categoria: 'Incidencia',
            estado: 'pendiente',
            tipo_incidencia: tipo,
            usuario_nombre: user.nombre || user.email,
            usuario_email: user.email,
            fecha_reporte: new Date().toISOString(),
            // Nota: No estamos subiendo im√°genes todav√≠a
            // Para subir im√°genes necesitar√≠as Supabase Storage
          };
          
          console.log('üì§ Enviando reporte:', reporteData);
          
          // Opci√≥n A: Guardar en la misma tabla 'denuncias'
          const { data, error } = await supabase
            .from('denuncias')
            .insert([reporteData])
            .select();
          
          if (error) {
            // Si falla, intentar con tabla 'reportes' si existe
            console.log('Intentando con tabla reportes...');
            const { data: data2, error: error2 } = await supabase
              .from('reportes')
              .insert([reporteData])
              .select();
            
            if (error2) throw error2;
            
            mostrarExito(data2[0].id, 'reporte');
          } else {
            mostrarExito(data[0].id, 'denuncia');
          }
          
          // Limpiar formulario
          form.reset();
          
        } catch (error) {
          console.error('‚ùå Error al enviar:', error);
          
          // Mensajes de error amigables
          if (error.message.includes('network')) {
            alert('‚ùå Error de conexi√≥n. Verifica tu internet.');
          } else if (error.message.includes('permission')) {
            alert('‚ùå Error de permisos. Contacta al administrador.');
          } else {
            alert(`‚ùå Error: ${error.message}\n\nUsa datos de prueba para la demo.`);
          }
          
        } finally {
          // Restaurar bot√≥n
          btnEnviar.innerHTML = textoOriginal;
          btnEnviar.disabled = false;
          btnEnviar.classList.remove('btn-loading');
        }
      });
      
      // 4. PRE-CARGAR DATOS DE PRUEBA PARA DEMOSTRACI√ìN
      document.getElementById('descripcion').value = 'Bache profundo de aproximadamente 50cm de di√°metro en la mitad de la calzada. Representa peligro para veh√≠culos peque√±os.';
      document.getElementById('ubicacion').value = 'Av. El Sol, altura del km 5, frente al Colegio San Francisco';
      
      console.log('‚úÖ Formulario de reporte listo');
    });
    
    // Funci√≥n para mostrar √©xito
    function mostrarExito(id, tipo) {
      const mensaje = `‚úÖ ¬°${tipo === 'denuncia' ? 'Denuncia' : 'Reporte'} enviado con √©xito!\n\n` +
                     `N√∫mero de seguimiento: CR-${id}\n` +
                     `Puedes ver el estado en "Estado de reportes".`;
      
      alert(mensaje);
      
      // Opcional: Redirigir despu√©s de 3 segundos
      setTimeout(() => {
        if (confirm('¬øQuieres ver todas las incidencias reportadas?')) {
          window.location.href = 'consultas.html';
        }
      }, 1000);
    }
    
    // 5. MANEJO DE IM√ÅGENES (versi√≥n futura)
    function manejarImagenes(archivos) {
      console.log('üì∏ Im√°genes seleccionadas:', archivos.length);
      // Para subir a Supabase Storage necesitar√≠as:
      // 1. Configurar bucket en Supabase
      // 2. Subir cada archivo con supabase.storage
      // 3. Guardar las URLs en la base de datos
      
      alert(`üì∏ ${archivos.length} imagen(es) seleccionada(s)\n\nEn una versi√≥n completa, estas se subir√≠an a la nube.`);
    }
    
    // Escuchar cambios en el input de im√°genes
    document.getElementById('foto')?.addEventListener('change', function(e) {
      if (this.files.length > 3) {
        alert('M√°ximo 3 im√°genes permitidas');
        this.value = '';
        return;
      }
      manejarImagenes(this.files);
    });
  </script>
</body>
</html>
