<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Usuario - Cusco Reporta</title>
  
  <!-- RUTAS CORREGIDAS para Netlify -->
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  
  <style>
    /* Estilos adicionales */
    .user-welcome {
      background: linear-gradient(135deg, #8b0000, #b22222);
      color: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 6px 20px rgba(139, 0, 0, 0.2);
    }
    
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }
    
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
      border-top: 4px solid #8b0000;
    }
    
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #8b0000;
      margin: 10px 0;
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .action-card {
      background: white;
      border-radius: 10px;
      padding: 25px;
      text-decoration: none;
      color: #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s;
      border-left: 5px solid #8b0000;
    }
    
    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      border-left-color: #ff6b6b;
    }
    
    .action-card i {
      font-size: 28px;
      color: #8b0000;
      margin-bottom: 15px;
    }
    
    .action-card h3 {
      margin: 10px 0;
      color: #222;
    }
    
    .action-card p {
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- ====== NAVBAR SUPERIOR ====== -->
  <header class="topbar">
    <div class="topbar__logo">
      <!-- RUTA CORREGIDA -->
      <img src="assents/images/CuscoReporta.png" alt="Cusco Reporta Logo">
    </div>
    <nav class="topbar__menu">
      <!-- RUTAS CORREGIDAS -->
      <a href="index.html">Inicio</a>
      <a href="sobre_nosotros.html">Sobre nosotros</a>
      <a href="ayuda.html">Ayuda</a>
      <a href="consultas.html">Ver Denuncias</a>
    </nav>
  </header>

  <!-- ====== CONTENEDOR PRINCIPAL ====== -->
  <div class="container">
    <!-- ====== SIDEBAR IZQUIERDO ====== -->
    <aside class="sidebar" style="display: flex; flex-direction: column; justify-content: flex-start;">
      <div class="sidebar__user" style="margin-bottom: 10px;">
        <div class="sidebar__avatar" id="userAvatar">
          <i class="fa-solid fa-user"></i>
        </div>
        <div class="sidebar__info">
          <h3 id="userName">Cargando...</h3>
          <p id="userRole">Ciudadano</p>
        </div>
      </div>

      <!-- Menú del usuario -->
      <ul class="sidebar__menu" style="margin-top: 0; padding-top: 0; list-style: none;">
        <li style="display: flex; align-items: flex-start;">
          <a href="perfil_usuario.html"><i class="fa-solid fa-id-card" style="width: 20px;"></i><span style="margin-left:8px;">Ver perfil</span></a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="registrar_Denuncia.html"><i class="fa-solid fa-pen-to-square" style="width: 20px;"></i><span style="margin-left:8px;">Nueva Denuncia</span></a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="consultas.html"><i class="fa-solid fa-list-check" style="width: 20px;"></i><span style="margin-left:8px;">Mis Denuncias</span></a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="MapaIncidiencias(Ciudadano).html"><i class="fa-solid fa-map-location-dot" style="width: 20px;"></i><span style="margin-left:8px;">Mapa de incidencias</span></a>
        </li>
        <li style="display: flex; align-items: flex-start;">
          <a href="notificaciones.html"><i class="fa-solid fa-bell" style="width: 20px;"></i><span style="margin-left:8px;">Notificaciones</span></a>
        </li>
      </ul>

      <button class="logout-btn" id="logoutBtn" style="margin-top: auto;">
        <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
      </button>
    </aside>

    <!-- ====== CONTENIDO PRINCIPAL ====== -->
    <main class="main-content">
      <!-- Bienvenida personalizada -->
      <div class="user-welcome">
        <h1 id="welcomeMessage">¡Bienvenido!</h1>
        <p style="margin-top:10px; opacity: 0.9;">
          Aquí puedes gestionar todas tus denuncias de tránsito en Cusco
        </p>
      </div>
      
      <!-- Estadísticas rápidas -->
      <div class="quick-stats">
        <div class="stat-card">
          <i class="fa-solid fa-file-circle-exclamation"></i>
          <div class="stat-number" id="totalDenuncias">0</div>
          <p>Denuncias Totales</p>
        </div>
        <div class="stat-card">
          <i class="fa-solid fa-clock"></i>
          <div class="stat-number" id="denunciasPendientes">0</div>
          <p>Pendientes</p>
        </div>
        <div class="stat-card">
          <i class="fa-solid fa-check-circle"></i>
          <div class="stat-number" id="denunciasResueltas">0</div>
          <p>Resueltas</p>
        </div>
        <div class="stat-card">
          <i class="fa-solid fa-chart-line"></i>
          <div class="stat-number" id="miContribucion">0</div>
          <p>Mis Reportes</p>
        </div>
      </div>
      
      <!-- Acciones rápidas -->
      <h2 style="margin-top: 30px;">¿Qué quieres hacer?</h2>
      <div class="quick-actions">
        <a href="registrar_Denuncia.html" class="action-card">
          <i class="fa-solid fa-triangle-exclamation"></i>
          <h3>Nueva Denuncia</h3>
          <p>Reporta una incidencia de tránsito en la ciudad</p>
        </a>
        
        <a href="consultas.html" class="action-card">
          <i class="fa-solid fa-list-check"></i>
          <h3>Ver Mis Denuncias</h3>
          <p>Revisa el estado de tus reportes anteriores</p>
        </a>
        
        <a href="perfil_usuario.html" class="action-card">
          <i class="fa-solid fa-user-edit"></i>
          <h3>Editar Perfil</h3>
          <p>Actualiza tu información personal</p>
        </a>
        
        <a href="MapaIncidiencias(Ciudadano).html" class="action-card">
          <i class="fa-solid fa-map-marked-alt"></i>
          <h3>Mapa de Incidencias</h3>
          <p>Visualiza reportes en el mapa de Cusco</p>
        </a>
      </div>
    </main>
  </div>

  <!-- ====== SCRIPTS ====== -->
  <!-- Cargar Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <script>
    // Configurar Supabase
    const SUPABASE_URL = 'https://grchvnewfkakaqfkgbzy.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bQZ1guTH9D2ByDwgMYGLfQ_g7bIsktc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    document.addEventListener('DOMContentLoaded', async function() {
      // 1. VERIFICAR SI HAY USUARIO LOGUEADO
      const userData = sessionStorage.getItem('user');
      
      if (!userData) {
        // No hay sesión, redirigir al login
        alert('❌ No hay sesión activa. Redirigiendo al login...');
        window.location.href = 'iniciar-sesion.html';
        return;
      }
      
      // 2. MOSTRAR INFORMACIÓN DEL USUARIO
      const user = JSON.parse(userData);
      console.log('Usuario en panel:', user);
      
      // Actualizar interfaz
      document.getElementById('userName').textContent = user.nombre || user.email.split('@')[0];
      document.getElementById('welcomeMessage').textContent = `¡Bienvenido, ${user.nombre || 'Usuario'}!`;
      document.getElementById('userAvatar').innerHTML = `<i class="fa-solid fa-user"></i>`;
      
      // 3. CARGAR ESTADÍSTICAS
      await cargarEstadisticas(user);
      
      // 4. CONFIGURAR LOGOUT
      document.getElementById('logoutBtn').addEventListener('click', async function() {
        if (confirm('¿Estás seguro de cerrar sesión?')) {
          try {
            // Cerrar sesión en Supabase Auth
            await supabase.auth.signOut();
          } catch (error) {
            console.log('Error en logout Supabase:', error);
          }
          
          // Limpiar sesión local
          sessionStorage.removeItem('user');
          alert('✅ Sesión cerrada correctamente');
          window.location.href = 'index.html';
        }
      });
    });
    
    // Función para cargar estadísticas
    async function cargarEstadisticas(user) {
      try {
        // Obtener TODAS las denuncias
        const { data: todasDenuncias, error } = await supabase
          .from('denuncias')
          .select('*');
        
        if (error) throw error;
        
        // Calcular estadísticas generales
        const total = todasDenuncias.length;
        const pendientes = todasDenuncias.filter(d => d.estado === 'pendiente').length;
        const resueltas = todasDenuncias.filter(d => d.estado === 'resuelto').length;
        
        // Calcular MIS denuncias (por email)
        const misDenuncias = todasDenuncias.filter(d => {
          // Si hay campo 'email' en denuncias
          if (d.email) return d.email === user.email;
          // O si hay campo 'user_id'
          if (d.user_id) return d.user_id === user.id;
          return false;
        }).length;
        
        // Actualizar UI
        document.getElementById('totalDenuncias').textContent = total;
        document.getElementById('denunciasPendientes').textContent = pendientes;
        document.getElementById('denunciasResueltas').textContent = resueltas;
        document.getElementById('miContribucion').textContent = misDenuncias;
        
      } catch (error) {
        console.error('Error cargando estadísticas:', error);
        // Mostrar datos de demo
        document.getElementById('totalDenuncias').textContent = '15';
        document.getElementById('denunciasPendientes').textContent = '8';
        document.getElementById('denunciasResueltas').textContent = '7';
        document.getElementById('miContribucion').textContent = '3';
      }
    }
    
    // 5. VERIFICAR PERIÓDICAMENTE LA SESIÓN (cada 5 min)
    setInterval(() => {
      if (!sessionStorage.getItem('user')) {
        alert('Tu sesión ha expirado. Por favor, inicia sesión nuevamente.');
        window.location.href = 'iniciar-sesion.html';
      }
    }, 300000); // 5 minutos
  </script>
</body>
</html>
